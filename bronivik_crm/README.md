# Bronivik CRM Bot

Почасовое бронирование кабинетов. Интегрировано с основным сервисом [Bronivik Jr](../README.md).

## Обзор

Bronivik CRM — это Telegram-бот для управления арендой кабинетов. Основная особенность: при бронировании времени бот синхронизируется с базой оборудования (Bronivik Jr), чтобы гарантировать, что выбранный аппарат свободен в это время.

## Функции

- **Почасовое бронирование**: выбор временных слотов согласно расписанию кабинета.
- **Синхронизация оборудования**: проверка доступности аппаратов через API Bronivik Jr.
- **Календарь**: удобный выбор даты через инлайн-клавиатуру.
- **Данные клиента**: сбор ФИО и телефона при бронировании (для CRM целей).
- **Панель менеджера**: инлайн-кнопки для оперативного подтверждения или отклонения заявок.
- **Кэширование**: использование Redis для ускорения проверок по API.

## Архитектура

Бот является частью моно-репозитория и использует общие зависимости Go.

- `internal/api`: HTTP-клиент для взаимодействия с Jr API.
- `internal/bot`: основная логика диалогов, стейт-машина бронирования.
- `internal/database`: хранение кабинетов, их расписания и почасовых записей (SQLite).

## Конфигурация (`configs/config.yaml`)

Основные разделы:

- `api`: URL и ключи для Bronivik Jr. По умолчанию: `http://grpc-api:8080` (внутри Docker).
- `booking`: правила бронирования.
  - `min_advance_minutes`: за сколько минут до начала можно создать бронь (по умолчанию 60).
  - `max_advance_days`: на сколько дней вперед открыта запись (по умолчанию 30).
  - `max_active_per_user`: лимит активных броней на одного пользователя.
- `managers`: список Telegram ID, которым приходят уведомления о новых заявках.

## Команды

### Пользовательские

- `/start` — приветствие.
- `/book` — запуск процесса бронирования (Кабинет -> Аппарат -> Дата -> Время -> Данные клиента).
- `/my_bookings` — список моих записей и их текущий статус.
- `/cancel_booking <ID>` — отмена текущей записи.
- `/help` — помощь.

### Команды менеджера

- `/pending` — список заявок, ожидающих решения.
- `/today_schedule` — занятость кабинетов на сегодня.
- `/tomorrow_schedule` — занятость на завтра.
- `/add_cabinet <name>` — добавление нового кабинета в базу.
- `/list_cabinets` — просмотр всех кабинетов и их ID.
- `/set_schedule <cab_id> <day_num> <start> <end>` — настройка рабочих часов кабинета.

## Установка и запуск

### В составе Docker Compose

Рекомендуется запускать через `docker compose` из корневой директории всего проекта:

```bash
docker compose up -d --build
```

### Локально

```bash
# Находясь в папке bronivik_crm
go run cmd/bot/main.go --config=configs/config.yaml
```

*Примечание: для корректной работы CRM-боту требуется запущенный сервис Bronivik Jr API.*

## Интеграция API

Бот использует REST API основного сервиса:

- `GET /api/v1/items`: получение списка аппаратов.
- `GET /api/v1/availability/{name}?date=...`: проверка доступности.

Авторизация происходит по двум заголовкам: `X-API-Key` и `X-API-Extra`.
